from pyspark.sql import SparkSession
from pyspark.sql.types import * 
from pyspark.sql.functions import *

spark = SparkSession.builder.appName("visits_join").getOrCreate()

df_visits_1_Basic_Events = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_1_Basic_Events").select("*")
df_visits_2_Ecommerce = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_2_Ecommerce").select("*")
df_visits_3_Goals = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_3_Goals").select("*")
df_visits_4_Device_Source = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_4_Device_Source").select("*")
df_visits_5_Attribution = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_5_Attribution").select("*")
df_visits_6_Attribution = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_6_Attribution").select("*")
df_visits_7_Attribution = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_7_Attribution").select("*")
df_visits_8_Attribution = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_8_Attribution").select("*")
df_visits_9_Attribution = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_9_Attribution").select("*")
df_visits_10_Attribution = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_10_Attribution").select("*")
df_visits_11_Attribution = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_11_Attribution").select("*")
df_visits_12_Attribution = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_12_Attribution").select("*")
df_visits_13_Attribution = spark.read.orc("/user/azhalybin/airflow/test/orc_visits_13_Attribution").select("*")

df_all_join = df_visits_1_Basic_Events   \
	.join(df_visits_2_Ecommerce, df_visits_1_Basic_Events.visitID_1 == df_visits_2_Ecommerce.visitID_2, "full")   \
	.join(df_visits_3_Goals, df_visits_1_Basic_Events.visitID_1 == df_visits_3_Goals.visitID_3, "full")   \
	.join(df_visits_4_Device_Source, df_visits_1_Basic_Events.visitID_1 == df_visits_4_Device_Source.visitID_4, "full")   \
	.join(df_visits_5_Attribution, df_visits_1_Basic_Events.visitID_1 == df_visits_5_Attribution.visitID_5, "full")   \
	.join(df_visits_6_Attribution, df_visits_1_Basic_Events.visitID_1 == df_visits_6_Attribution.visitID_6, "full")   \
	.join(df_visits_7_Attribution, df_visits_1_Basic_Events.visitID_1 == df_visits_7_Attribution.visitID_7, "full")   \
	.join(df_visits_8_Attribution, df_visits_1_Basic_Events.visitID_1 == df_visits_8_Attribution.visitID_8, "full")   \
	.join(df_visits_9_Attribution, df_visits_1_Basic_Events.visitID_1 == df_visits_9_Attribution.visitID_9, "full")   \
	.join(df_visits_10_Attribution, df_visits_1_Basic_Events.visitID_1 == df_visits_10_Attribution.visitID_10, "full")   \
	.join(df_visits_11_Attribution, df_visits_1_Basic_Events.visitID_1 == df_visits_11_Attribution.visitID_11, "full")   \
	.join(df_visits_12_Attribution, df_visits_1_Basic_Events.visitID_1 == df_visits_12_Attribution.visitID_12, "full")   \
	.join(df_visits_13_Attribution, df_visits_1_Basic_Events.visitID_1 == df_visits_13_Attribution.visitID_13, "full")   \

df_all_visits = df_all_join.select(
	col('visitID_1').alias('visitID'),
	col('date_1').alias('date'),
	col('bounce'),
	col('clientID'),
	col('counterID'),
	col('counterUserIDHash'),
	col('dateTime'),
	col('dateTimeUTC'),
	col('endURL'),
	col('ipAddress'),
	col('isNewUser'),
	col('pageViews'),
	col('regionCity'),
	col('regionCityID'),
	col('regionCountry'),
	col('regionCountryID'),
	col('startURL'),
	col('visitDuration'),
	col('watchIDs'),
	col('parsedParamsKey1'),
	col('parsedParamsKey10'),
	col('parsedParamsKey2'),
	col('parsedParamsKey3'),
	col('parsedParamsKey4'),
	col('parsedParamsKey5'),
	col('parsedParamsKey6'),
	col('parsedParamsKey7'),
	col('parsedParamsKey8'),
	col('parsedParamsKey9'),
	col('goalsCurrency'),
	col('goalsDateTime'),
	col('goalsID'),
	col('goalsOrder'),
	col('goalsPrice'),
	col('goalsSerialNumber'),
	col('impressionsProductVariant'),
	col('impressionsURL'),
	col('productsBrand'),
	col('productsCategory'),
	col('productsCategory1'),
	col('productsCategory2'),
	col('productsCategory3'),
	col('productsCategory4'),
	col('productsCoupon'),
	col('productsCurrency'),
	col('productsDiscount'),
	col('productsEventTime'),
	col('productsID'),
	col('productsList'),
	col('productsName'),
	col('productsPosition'),
	col('productsPrice'),
	col('productsPurchaseID'),
	col('productsQuantity'),
	col('productsVariant'),
	col('promotionCreative'),
	col('promotionCreativeSlot'),
	col('promotionEventTime'),
	col('promotionID'),
	col('promotionName'),
	col('promotionPosition'),
	col('promotionType'),
	col('purchaseAffiliation'),
	col('purchaseCoupon'),
	col('purchaseCurrency'),
	col('purchaseDateTime'),
	col('purchaseID'),
	col('purchaseProductQuantity'),
	col('purchaseRevenue'),
	col('automaticAdvEngine'),
	col('automaticClickBannerGroupName'),
	col('automaticCurrencyID'),
	col('automaticDirectBannerGroup'),
	col('automaticDirectClickBanner'),
	col('automaticDirectClickBannerName'),
	col('automaticDirectClickOrder'),
	col('automaticDirectClickOrderName'),
	col('automaticDirectConditionType'),
	col('automaticDirectPhraseOrCond'),
	col('automaticDirectPlatform'),
	col('automaticDirectPlatformType'),
	col('automaticGCLID'),
	col('automatichasGCLID'),
	col('automaticMessenger'),
	col('automaticRecommendationSystem'),
	col('automaticReferalSource'),
	col('automaticSearchEngine'),
	col('automaticSearchEngineRoot'),
	col('automaticSocialNetwork'),
	col('automaticSocialNetworkProfile'),
	col('automaticTrafficSource'),
	col('automaticUTMCampaign'),
	col('automaticUTMContent'),
	col('automaticUTMMedium'),
	col('automaticUTMSource'),
	col('automaticUTMTerm'),
	col('from'),
	col('referer'),
	col('browser'),
	col('browserCountry'),
	col('browserEngine'),
	col('browserEngineVersion1'),
	col('browserEngineVersion2'),
	col('browserEngineVersion3'),
	col('browserEngineVersion4'),
	col('browserLanguage'),
	col('browserMajorVersion'),
	col('browserMinorVersion'),
	col('clientTimeZone'),
	col('cookieEnabled'),
	col('deviceCategory'),
	col('javascriptEnabled'),
	col('mobilePhone'),
	col('mobilePhoneModel'),
	col('operatingSystem'),
	col('operatingSystemRoot'),
	col('physicalScreenHeight'),
	col('physicalScreenWidth'),
	col('screenColors'),
	col('screenFormat'),
	col('screenHeight'),
	col('screenOrientation'),
	col('screenWidth'),
	col('windowClientHeight'),
	col('windowClientWidth'),
	col('cross_device_firstAdvEngine'),
	col('cross_device_firstClickBannerGroupName'),
	col('cross_device_firstCurrencyID'),
	col('cross_device_firstDirectBannerGroup'),
	col('cross_device_firstDirectClickBanner'),
	col('cross_device_firstDirectClickBannerName'),
	col('cross_device_firstDirectClickOrder'),
	col('cross_device_firstDirectClickOrderName'),
	col('cross_device_firstDirectConditionType'),
	col('cross_device_firstDirectPhraseOrCond'),
	col('cross_device_firstDirectPlatform'),
	col('cross_device_firstDirectPlatformType'),
	col('cross_device_firstGCLID'),
	col('cross_device_firsthasGCLID'),
	col('cross_device_firstMessenger'),
	col('cross_device_firstRecommendationSystem'),
	col('cross_device_firstReferalSource'),
	col('cross_device_firstSearchEngine'),
	col('cross_device_firstSearchEngineRoot'),
	col('cross_device_firstSocialNetwork'),
	col('cross_device_firstSocialNetworkProfile'),
	col('cross_device_firstTrafficSource'),
	col('cross_device_firstUTMCampaign'),
	col('cross_device_firstUTMContent'),
	col('cross_device_firstUTMMedium'),
	col('cross_device_firstUTMSource'),
	col('cross_device_firstUTMTerm'),
	col('cross_device_lastAdvEngine'),
	col('cross_device_lastClickBannerGroupName'),
	col('cross_device_lastCurrencyID'),
	col('cross_device_lastDirectBannerGroup'),
	col('cross_device_lastDirectClickBanner'),
	col('cross_device_lastDirectClickBannerName'),
	col('cross_device_lastDirectClickOrder'),
	col('cross_device_lastDirectClickOrderName'),
	col('cross_device_lastDirectConditionType'),
	col('cross_device_lastDirectPhraseOrCond'),
	col('cross_device_lastDirectPlatform'),
	col('cross_device_lastDirectPlatformType'),
	col('cross_device_lastGCLID'),
	col('cross_device_lasthasGCLID'),
	col('cross_device_lastMessenger'),
	col('cross_device_lastRecommendationSystem'),
	col('cross_device_lastReferalSource'),
	col('cross_device_lastSearchEngine'),
	col('cross_device_lastSearchEngineRoot'),
	col('cross_device_lastSocialNetwork'),
	col('cross_device_lastSocialNetworkProfile'),
	col('cross_device_lastTrafficSource'),
	col('cross_device_lastUTMCampaign'),
	col('cross_device_lastUTMContent'),
	col('cross_device_lastUTMMedium'),
	col('cross_device_lastUTMSource'),
	col('cross_device_lastUTMTerm'),
	col('cross_device_last_significantAdvEngine'),
	col('cross_device_last_significantClickBannerGroupName'),
	col('cross_device_last_significantCurrencyID'),
	col('cross_device_last_significantDirectBannerGroup'),
	col('cross_device_last_significantDirectClickBanner'),
	col('cross_device_last_significantDirectClickBannerName'),
	col('cross_device_last_significantDirectClickOrder'),
	col('cross_device_last_significantDirectClickOrderName'),
	col('cross_device_last_significantDirectConditionType'),
	col('cross_device_last_significantDirectPhraseOrCond'),
	col('cross_device_last_significantDirectPlatform'),
	col('cross_device_last_significantDirectPlatformType'),
	col('cross_device_last_significantGCLID'),
	col('cross_device_last_significanthasGCLID'),
	col('cross_device_last_significantMessenger'),
	col('cross_device_last_significantRecommendationSystem'),
	col('cross_device_last_significantReferalSource'),
	col('cross_device_last_significantSearchEngine'),
	col('cross_device_last_significantSearchEngineRoot'),
	col('cross_device_last_significantSocialNetwork'),
	col('cross_device_last_significantSocialNetworkProfile'),
	col('cross_device_last_significantTrafficSource'),
	col('cross_device_last_significantUTMCampaign'),
	col('cross_device_last_significantUTMContent'),
	col('cross_device_last_significantUTMMedium'),
	col('cross_device_last_significantUTMSource'),
	col('cross_device_last_significantUTMTerm'),
	col('cross_device_last_yandex_direct_clickAdvEngine'),
	col('cross_device_last_yandex_direct_clickClickBannerGroupName'),
	col('cross_device_last_yandex_direct_clickCurrencyID'),
	col('cross_device_last_yandex_direct_clickDirectBannerGroup'),
	col('cross_device_last_yandex_direct_clickDirectClickBanner'),
	col('cross_device_last_yandex_direct_clickDirectClickBannerName'),
	col('cross_device_last_yandex_direct_clickDirectClickOrder'),
	col('cross_device_last_yandex_direct_clickDirectClickOrderName'),
	col('cross_device_last_yandex_direct_clickDirectConditionType'),
	col('cross_device_last_yandex_direct_clickDirectPhraseOrCond'),
	col('cross_device_last_yandex_direct_clickDirectPlatform'),
	col('cross_device_last_yandex_direct_clickDirectPlatformType'),
	col('cross_device_last_yandex_direct_clickGCLID'),
	col('cross_device_last_yandex_direct_clickhasGCLID'),
	col('cross_device_last_yandex_direct_clickMessenger'),
	col('cross_device_last_yandex_direct_clickRecommendationSystem'),
	col('cross_device_last_yandex_direct_clickReferalSource'),
	col('cross_device_last_yandex_direct_clickSearchEngine'),
	col('cross_device_last_yandex_direct_clickSearchEngineRoot'),
	col('cross_device_last_yandex_direct_clickSocialNetwork'),
	col('cross_device_last_yandex_direct_clickSocialNetworkProfile'),
	col('cross_device_last_yandex_direct_clickTrafficSource'),
	col('cross_device_last_yandex_direct_clickUTMCampaign'),
	col('cross_device_last_yandex_direct_clickUTMContent'),
	col('cross_device_last_yandex_direct_clickUTMMedium'),
	col('cross_device_last_yandex_direct_clickUTMSource'),
	col('cross_device_last_yandex_direct_clickUTMTerm'),
	col('firstAdvEngine'),
	col('firstClickBannerGroupName'),
	col('firstCurrencyID'),
	col('firstDirectBannerGroup'),
	col('firstDirectClickBanner'),
	col('firstDirectClickBannerName'),
	col('firstDirectClickOrder'),
	col('firstDirectClickOrderName'),
	col('firstDirectConditionType'),
	col('firstDirectPhraseOrCond'),
	col('firstDirectPlatform'),
	col('firstDirectPlatformType'),
	col('firstGCLID'),
	col('firsthasGCLID'),
	col('firstMessenger'),
	col('firstRecommendationSystem'),
	col('firstReferalSource'),
	col('firstSearchEngine'),
	col('firstSearchEngineRoot'),
	col('firstSocialNetwork'),
	col('firstSocialNetworkProfile'),
	col('firstTrafficSource'),
	col('firstUTMCampaign'),
	col('firstUTMContent'),
	col('firstUTMMedium'),
	col('firstUTMSource'),
	col('firstUTMTerm'),
	col('lastAdvEngine'),
	col('lastClickBannerGroupName'),
	col('lastCurrencyID'),
	col('lastDirectBannerGroup'),
	col('lastDirectClickBanner'),
	col('lastDirectClickBannerName'),
	col('lastDirectClickOrder'),
	col('lastDirectClickOrderName'),
	col('lastDirectConditionType'),
	col('lastDirectPhraseOrCond'),
	col('lastDirectPlatform'),
	col('lastDirectPlatformType'),
	col('lastGCLID'),
	col('lasthasGCLID'),
	col('lastMessenger'),
	col('lastRecommendationSystem'),
	col('lastReferalSource'),
	col('lastSearchEngine'),
	col('lastSearchEngineRoot'),
	col('lastSocialNetwork'),
	col('lastSocialNetworkProfile'),
	col('lastTrafficSource'),
	col('lastUTMCampaign'),
	col('lastUTMContent'),
	col('lastUTMMedium'),
	col('lastUTMSource'),
	col('lastUTMTerm'),
	col('last_yandex_direct_clickAdvEngine'),
	col('last_yandex_direct_clickClickBannerGroupName'),
	col('last_yandex_direct_clickCurrencyID'),
	col('last_yandex_direct_clickDirectBannerGroup'),
	col('last_yandex_direct_clickDirectClickBanner'),
	col('last_yandex_direct_clickDirectClickBannerName'),
	col('last_yandex_direct_clickDirectClickOrder'),
	col('last_yandex_direct_clickDirectClickOrderName'),
	col('last_yandex_direct_clickDirectConditionType'),
	col('last_yandex_direct_clickDirectPhraseOrCond'),
	col('last_yandex_direct_clickDirectPlatform'),
	col('last_yandex_direct_clickDirectPlatformType'),
	col('last_yandex_direct_clickGCLID'),
	col('last_yandex_direct_clickhasGCLID'),
	col('last_yandex_direct_clickMessenger'),
	col('last_yandex_direct_clickRecommendationSystem'),
	col('last_yandex_direct_clickReferalSource'),
	col('last_yandex_direct_clickSearchEngine'),
	col('last_yandex_direct_clickSearchEngineRoot'),
	col('last_yandex_direct_clickSocialNetwork'),
	col('last_yandex_direct_clickSocialNetworkProfile'),
	col('last_yandex_direct_clickTrafficSource'),
	col('last_yandex_direct_clickUTMCampaign'),
	col('last_yandex_direct_clickUTMContent'),
	col('last_yandex_direct_clickUTMMedium'),
	col('last_yandex_direct_clickUTMSource'),
	col('last_yandex_direct_clickUTMTerm'),
	col('lastsignAdvEngine'),
	col('lastsignClickBannerGroupName'),
	col('lastsignCurrencyID'),
	col('lastsignDirectBannerGroup'),
	col('lastsignDirectClickBanner'),
	col('lastsignDirectClickBannerName'),
	col('lastsignDirectClickOrder'),
	col('lastsignDirectClickOrderName'),
	col('lastsignDirectConditionType'),
	col('lastsignDirectPhraseOrCond'),
	col('lastsignDirectPlatform'),
	col('lastsignDirectPlatformType'),
	col('lastsignGCLID'),
	col('lastsignhasGCLID'),
	col('lastsignMessenger'),
	col('lastsignRecommendationSystem'),
	col('lastsignReferalSource'),
	col('lastsignSearchEngine'),
	col('lastsignSearchEngineRoot'),
	col('lastsignSocialNetwork'),
	col('lastsignSocialNetworkProfile'),
	col('lastsignTrafficSource'),
	col('lastsignUTMCampaign'),
	col('lastsignUTMContent'),
	col('lastsignUTMMedium'),
	col('lastsignUTMSource'),
	col('lastsignUTMTerm'),
	col('eventsProductBrand'),
	col('eventsProductCategory'),
	col('eventsProductCategory1'),
	col('eventsProductCategory2'),
	col('eventsProductCategory3'),
	col('eventsProductCategory4'),
	col('eventsProductCoupon'),
	col('eventsProductCurrency'),
	col('eventsProductDiscount'),
	col('eventsProductEventTime'),
	col('eventsProductID'),
	col('eventsProductList'),
	col('eventsProductName'),
	col('eventsProductPosition'),
	col('eventsProductPrice'),
	col('eventsProductQuantity'),
	col('eventsProductType'),
	col('eventsProductVariant'),
	col('impressionsDateTime'),
	col('impressionsProductBrand'),
	col('impressionsProductCategory'),
	col('impressionsProductCategory1'),
	col('impressionsProductCategory2'),
	col('impressionsProductCategory3'),
	col('impressionsProductCategory4'),
	col('impressionsProductCoupon'),
	col('impressionsProductCurrency'),
	col('impressionsProductDiscount'),
	col('impressionsProductEventTime'),
	col('impressionsProductID'),
	col('impressionsProductList'),
	col('impressionsProductName'),
	col('impressionsProductPrice'),
	col('impressionsProductQuantity')
).distinct()

df_all_visits.show(3)

df_all_visits.write.format("orc") \
			.mode("append") \
			.partitionBy("date") \
			.option("maxRecordsPerFile", 150000) \
			.save("/user/azhalybin/airflow/test/orc_visits_join")